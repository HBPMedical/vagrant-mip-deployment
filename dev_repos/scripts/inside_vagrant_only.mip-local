#!/usr/bin/env bash

MIP_LINK=""
EXTERNAL_MIP_PROTOCOL=""
PUBLIC_MIP_PROTOCOL=""
PUBLIC_MIP_HOST=""
KEYCLOAK_PROTOCOL=""
KEYCLOAK_URL=""
TAG=""
BRANCH=""
COMMIT=""

POSITIONAL=()
while [[ $# -gt 0 ]]; do
	case $1 in
		--mip-link)
			MIP_LINK="$2"
			shift
			shift
			;;
		--external-mip-protocol)
			EXTERNAL_MIP_PROTOCOL="$2"
			shift
			shift
			;;
		--public-mip-protocol)
			PUBLIC_MIP_PROTOCOL="$2"
			shift
			shift
			;;
		--public-mip-host)
			PUBLIC_MIP_HOST="$2"
			shift
			shift
			;;
		--keycloak-protocol)
			KEYCLOAK_PROTOCOL="$2"
			shift
			shift
			;;
		--keycloak-url)
			KEYCLOAK_URL="$2"
			shift
			shift
			;;
		--tag)
			TAG="$2"
			shift
			shift
			;;
		--branch)
			BRANCH="$2"
			shift
			shift
			;;
		--commit)
			COMMIT="$2"
			shift
			shift
			;;
		*)
			POSITIONAL+=("$1")
			shift
			;;
	esac
done
set -- "${POSITIONAL[@]}"

ret=1
if [[ "$MIP_LINK" = "" || "$EXTERNAL_MIP_PROTOCOL" = "" || "$PUBLIC_MIP_PROTOCOL" = "" || "$PUBLIC_MIP_HOST" = "" || "$KEYCLOAK_PROTOCOL" = "" || "$KEYCLOAK_URL" = "" ]]; then
	exit $ret
fi

export DEBIAN_FRONTEND=noninteractive

ret=0
if [[ $ret -eq 0 ]]; then
	if [[ "$TAG" != "" || "$BRANCH" != "" || "$COMMIT" != "" ]]; then
		echo "/vagrant/dev_repos/mip-deployment/mip --quiet --yes --force-install-unstable --version \"$TAG\" --branch \"$BRANCH\" --commit \"$COMMIT\" --no-run --keep-installer install"
		/vagrant/dev_repos/mip-deployment/mip --quiet --yes --force-install-unstable --version "$TAG" --branch "$BRANCH" --commit "$COMMIT" --no-run --keep-installer install
	else
		echo "/vagrant/dev_repos/mip-deployment/mip --quiet --yes --no-run --keep-installer install"
		/vagrant/dev_repos/mip-deployment/mip --quiet --yes --no-run --keep-installer install
	fi
	ret=$?
fi

if [[ $ret -eq 0 ]]; then
	# --host MUST MATCH YOUR DESKTOP <HOST> IP or FQDN (i.e. if behind a reverse-proxy)
	echo "Configuring the MIP..."
	echo "/vagrant/dev_repos/mip-deployment/mip --quiet --yes --link \"$MIP_LINK\" --ext-protocol \"$EXTERNAL_MIP_PROTOCOL\" --protocol \"$PUBLIC_MIP_PROTOCOL\" --host \"$PUBLIC_MIP_HOST\" --with-keycloak-authentication --keycloak-protocol \"$KEYCLOAK_PROTOCOL\" --keycloak-url \"$KEYCLOAK_URL\" configure all"
	/vagrant/dev_repos/mip-deployment/mip --quiet --yes --link "$MIP_LINK" --ext-protocol "$EXTERNAL_MIP_PROTOCOL" --protocol "$PUBLIC_MIP_PROTOCOL" --host "$PUBLIC_MIP_HOST" --with-keycloak-authentication --keycloak-protocol "$KEYCLOAK_PROTOCOL" --keycloak-url "$KEYCLOAK_URL" configure all
	ret=$?
fi

if [[ $ret -eq 0 ]]; then
	echo "Stopping the MIP..."
	echo "/vagrant/dev_repos/mip-deployment/mip --quiet --yes stop"
	/vagrant/dev_repos/mip-deployment/mip --quiet --yes stop
	ret=$?
	if [[ $ret -ne 0 ]]; then
		echo "Exit code $ret. Forcing to 0."
		ret=0
	fi
fi

if [[ $ret -eq 0 ]]; then
	if [[ -d /vagrant/data ]]; then
		echo "rm -rf /opt/mip-deployment/data"
		rm -rf /opt/mip-deployment/data
		ret=$?
	else
		echo "mv /opt/mip-deployment/data /vagrant/"
		mv /opt/mip-deployment/data /vagrant/
		ret=$?
	fi

	if [[ $ret -eq 0 ]]; then
		echo "ln -s /vagrant/data /opt/mip-deployment/"
		ln -s /vagrant/data /opt/mip-deployment/
	fi
fi

if [[ $ret -eq 0 ]]; then
	echo "/vagrant/dev_repos/mip-deployment/mip data consolidate"
	/vagrant/dev_repos/mip-deployment/mip data consolidate
	ret=$?
fi

if [[ $ret -eq 0 ]]; then
	echo "/vagrant/dev_repos/mip-deployment/mip data compile"
	/vagrant/dev_repos/mip-deployment/mip data compile
	ret=$?
fi

if [[ $ret -eq 0 ]]; then
	echo "Starting the MIP..."
	echo "/vagrant/dev_repos/mip-deployment/mip --quiet --yes start"
	/vagrant/dev_repos/mip-deployment/mip --quiet --yes start
	ret=$?
	if [[ $ret -ne 0 ]]; then
		echo "Exit code $ret. Forcing to 0."
		ret=0
	fi
fi

exit $ret
