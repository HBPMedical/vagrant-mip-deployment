#!/usr/bin/env bash

EXAREME_IP=""
MIP_LINK=""
EXTERNAL_MIP_PROTOCOL=""
PUBLIC_MIP_PROTOCOL=""
PUBLIC_MIP_HOST=""
KEYCLOAK_PROTOCOL=""
KEYCLOAK_URL=""
KEYCLOAK_REALM=""
KEYCLOAK_CLIENT_ID=""
KEYCLOAK_CLIENT_SECRET=""
TAG=""
BRANCH=""
COMMIT=""

POSITIONAL=()
while [[ $# -gt 0 ]]; do
	case $1 in
		--exareme-ip)
			EXAREME_IP="$2"
			shift
			shift
			;;
		--mip-link)
			MIP_LINK="$2"
			shift
			shift
			;;
		--external-mip-protocol)
			EXTERNAL_MIP_PROTOCOL="$2"
			shift
			shift
			;;
		--public-mip-protocol)
			PUBLIC_MIP_PROTOCOL="$2"
			shift
			shift
			;;
		--public-mip-host)
			PUBLIC_MIP_HOST="$2"
			shift
			shift
			;;
		--keycloak-protocol)
			KEYCLOAK_PROTOCOL="$2"
			shift
			shift
			;;
		--keycloak-url)
			KEYCLOAK_URL="$2"
			shift
			shift
			;;
		--keycloak-realm)
			KEYCLOAK_REALM="$2"
			shift
			shift
			;;
		--keycloak-client-id)
			KEYCLOAK_CLIENT_ID="$2"
			shift
			shift
			;;
		--keycloak-client-secret)
			KEYCLOAK_CLIENT_SECRET="$2"
			shift
			shift
			;;
		--tag)
			TAG="$2"
			shift
			shift
			;;
		--branch)
			BRANCH="$2"
			shift
			shift
			;;
		--commit)
			COMMIT="$2"
			shift
			shift
			;;
		*)
			POSITIONAL+=("$1")
			shift
			;;
	esac
done
set -- "${POSITIONAL[@]}"

ret=1
if [[ "$MIP_LINK" = "" || "$EXTERNAL_MIP_PROTOCOL" = "" || "$PUBLIC_MIP_PROTOCOL" = "" || "$PUBLIC_MIP_HOST" = "" ]]; then
	exit $ret
fi

export DEBIAN_FRONTEND=noninteractive

ret=0
if [[ $ret -eq 0 ]]; then
	if [[ "$TAG" != "" || "$BRANCH" != "" || "$COMMIT" != "" ]]; then
		echo "/vagrant/dev_repos/mip-deployment/mip --node-type ui --quiet --yes --force-install-unstable --version \"$TAG\" --branch \"$BRANCH\" --commit \"$COMMIT\" --no-run --keep-installer install"
		/vagrant/dev_repos/mip-deployment/mip --node-type ui --quiet --yes --force-install-unstable --version "$TAG" --branch "$BRANCH" --commit "$COMMIT" --no-run --keep-installer install
	else
		echo "/vagrant/dev_repos/mip-deployment/mip --node-type ui --quiet --yes --no-run --keep-installer install"
		/vagrant/dev_repos/mip-deployment/mip --node-type ui --quiet --yes --no-run --keep-installer install
	fi
	ret=$?
fi

if [[ $ret -eq 0 && "$EXAREME_IP" = "" ]]; then
	EXAREME_IP=$(awk '/^guest .*ms / {print $3}' /vagrant/hosts.dat)
	if [[ "$EXAREME_IP" = "" ]]; then
		ret=1
	fi
fi

if [[ $ret -eq 0 ]]; then
	# --host MUST MATCH YOUR DESKTOP <HOST> IP or FQDN (i.e. if behind a reverse-proxy)
	echo "Configuring the MIP UI..."
	#/vagrant/dev_repos/mip-deployment/mip --node-type ui --quiet --yes --host $(awk '/^host/ {if(NF == 4) print $4; else print $3}' /vagrant/hosts.dat):$(grep -E -A10 "^[ \t]+config.vm.define \"ui\"" /vagrant/Vagrantfile | grep forwarded_port | awk -F 'host:' '{print $2}' | awk -F ',' '{print $1}' | awk '{print $1}') --exareme-ip $(awk '/^guest .*ms / {print $3}' /vagrant/hosts.dat) --with-keycloak-authentication configure all

	MIP_PARAMS=()
	MIP_PARAMS+=("--node-type ui")
	MIP_PARAMS+=("--quiet")
	MIP_PARAMS+=("--yes")
	MIP_PARAMS+=("--link $MIP_LINK")
	MIP_PARAMS+=("--ext-protocol $EXTERNAL_MIP_PROTOCOL")
	MIP_PARAMS+=("--protocol $PUBLIC_MIP_PROTOCOL")
	MIP_PARAMS+=("--host $PUBLIC_MIP_HOST")
	if [[ "$EXAREME_IP" != "" ]]; then
		MIP_PARAMS+=("--exareme-ip $EXAREME_IP")
	fi
	if [[ "$KEYCLOAK_PROTOCOL" != "" || "$KEYCLOAK_URL" != "" || "$KEYCLOAK_REALM" != "" || "$KEYCLOAK_CLIENT_ID" != "" || "$KEYCLOAK_CLIENT_SECRET" != "" ]]; then
		MIP_PARAMS+=("--with-keycloak-authentication")
		if [[ "$KEYCLOAK_PROTOCOL" != "" ]]; then
			MIP_PARAMS+=("--keycloak-protocol $KEYCLOAK_PROTOCOL")
		fi
		if [[ "$KEYCLOAK_URL" != "" ]]; then
			MIP_PARAMS+=("--keycloak-url $KEYCLOAK_URL")
		fi
		if [[ "$KEYCLOAK_REALM" != "" ]]; then
			MIP_PARAMS+=("--keycloak-realm $KEYCLOAK_REALM")
		fi
		if [[ "$KEYCLOAK_CLIENT_ID" != "" ]]; then
			MIP_PARAMS+=("--keycloak-client-id $KEYCLOAK_CLIENT_ID")
		fi
		if [[ "$KEYCLOAK_CLIENT_SECRET" != "" ]]; then
			MIP_PARAMS+=("--keycloak-client-secret $KEYCLOAK_CLIENT_SECRET")
		fi
	else
		MIP_PARAMS+=("--without-keycloak-authentication")
	fi

	echo "/vagrant/dev_repos/mip-deployment/mip ${MIP_PARAMS[*]} configure all"
	/vagrant/dev_repos/mip-deployment/mip --debug-level 6 ${MIP_PARAMS[@]} configure all
	ret=$?
fi

if [[ $ret -eq 0 ]]; then
	echo "Stopping the MIP UI..."
	/vagrant/dev_repos/mip-deployment/mip --quiet --yes stop
	ret=$?
	if [[ $ret -ne 0 ]]; then
		echo "Exit code $ret. Forcing to 0."
		ret=0
	fi
fi

if [[ $ret -eq 0 ]]; then
	echo "Starting the MIP UI..."
	/vagrant/dev_repos/mip-deployment/mip --quiet --yes start
	ret=$?
	if [[ $ret -ne 0 ]]; then
		echo "Exit code $ret. Forcing to 0."
		ret=0
	fi
fi

exit $ret
